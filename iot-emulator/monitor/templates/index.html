<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IoT Emulator Monitor</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7fa; margin: 0; }
        h1 { text-align: center; margin-top: 20px; }
        #devices { max-width: 700px; margin: 30px auto; }
        .device { border: 1px solid #b3b3cc; border-radius: 8px; background: #fff; box-shadow: 0 2px 8px #0001; padding: 18px 20px 12px 20px; margin: 18px 0; transition: opacity 0.3s, background 0.3s; opacity: 1; position: relative; }
        .device.removed { opacity: 0; }
        .status { font-weight: bold; }
        .status.running { color: #2e8b57; }
        .status.stopped { color: #b22222; }
        .status.idle { color: #888; }
        .status.error { color: #d2691e; }
        .dev-header { font-size: 1.1em; margin-bottom: 6px; }
        .dev-meta { color: #666; font-size: 0.95em; margin-bottom: 8px; }
        button { margin: 4px 6px 4px 0; padding: 5px 14px; border-radius: 5px; border: 1px solid #b3b3cc; background: #f0f0fa; cursor: pointer; transition: background 0.2s; font-size: 1em; }
        button:hover { background: #e0e0f7; }
        .scenarios { margin: 10px 0 6px 0; }
        .scenarios-title { font-weight: bold; margin-right: 8px; }
        .history-table { border-collapse: collapse; width: 100%; margin-top: 8px; background: #fafaff; }
        .history-table th, .history-table td { border: 1px solid #e0e0e0; padding: 4px 8px; text-align: left; font-size: 0.97em; }
        .history-table th { background: #f0f0fa; }
        .history-title { font-weight: bold; margin-top: 10px; }
        .close-btn { float: right; background: #f7f7fa; border: none; color: #888; font-size: 1.2em; cursor: pointer; margin-top: -6px; }
        .close-btn:hover { color: #b22222; background: #f0e0e0; }
    </style>
</head>
<body>
    <h1>IoT Device Emulator</h1>
    <div id="devices"></div>
    <script>
        const statusMap = {"0": "Stopped", "1": "Running", "2": "Idle", "3": "Error"};
        const statusClass = {"0": "stopped", "1": "running", "2": "idle", "3": "error"};
        const deviceMap = new Map();

        function renderScenarios(dev) {
            if (Array.isArray(dev.scenarios) && dev.scenarios.length > 0) {
                return `<span class='scenarios-title'>–°—Ü–µ–Ω–∞—Ä–∏–∏:</span>` +
                    dev.scenarios.map(s => `<button title='–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π' onclick=\"runScenario('${dev.id}','${s}')\">‚ñ∂ ${s}</button>`).join(' ');
            } else {
                return '<i>–ù–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤</i>';
            }
        }

        function renderDevice(dev) {
            const div = document.createElement('div');
            div.className = 'device';
            div.setAttribute('data-id', dev.id);
            div.innerHTML = `
                <div class="dev-header"><b>${dev.name}</b></div>
                <div class="dev-meta">ID: <span>${dev.id}</span> | –ü—Ä–æ—Ç–æ–∫–æ–ª: <span>${dev.protocol}</span></div>
                <div>–°—Ç–∞—Ç—É—Å: <span class="status ${statusClass[dev.status] || ''}">${statusMap[dev.status] || dev.status}</span></div>
                <div class="scenarios">${renderScenarios(dev)}</div>
                <button title="–ó–∞–ø—É—Å—Ç–∏—Ç—å" onclick="startDevice('${dev.id}')">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                <button title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" onclick="stopDevice('${dev.id}')">‚ñ† –°—Ç–æ–ø</button>
                <button title="–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é" onclick="showHistory('${dev.id}')">üìà –ò—Å—Ç–æ—Ä–∏—è</button>
                <div id="history-${dev.id}" style="margin-top:5px;"></div>
            `;
            document.getElementById('devices').appendChild(div);
        }

        function updateDevice(dev) {
            const div = document.querySelector(`[data-id="${dev.id}"]`);
            if (!div) return;
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏
            const statusSpan = div.querySelector('.status');
            if (statusSpan.innerText !== (statusMap[dev.status] || dev.status)) {
                statusSpan.innerText = statusMap[dev.status] || dev.status;
                statusSpan.className = 'status ' + (statusClass[dev.status] || '');
                div.style.background = '#e6ffe6';
                setTimeout(() => div.style.background = '', 300);
            }
            div.querySelector('.scenarios').innerHTML = renderScenarios(dev);
        }

        async function fetchDevices() {
            const resp = await fetch('/api/devices');
            const devices = await resp.json();
            const ids = new Set();
            devices.forEach(dev => {
                ids.add(dev.id);
                if (!deviceMap.has(dev.id)) {
                    renderDevice(dev);
                    deviceMap.set(dev.id, dev);
                } else {
                    updateDevice(dev);
                    deviceMap.set(dev.id, dev);
                }
            });
            // –£–¥–∞–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç
            document.querySelectorAll('.device').forEach(div => {
                const id = div.getAttribute('data-id');
                if (!ids.has(id)) {
                    div.classList.add('removed');
                    setTimeout(() => div.remove(), 300);
                    deviceMap.delete(id);
                }
            });
        }
        async function startDevice(id) {
            await fetch(`/api/devices/${id}/start`, {method: 'POST'});
            await updateDeviceFromServer(id);
        }
        async function stopDevice(id) {
            await fetch(`/api/devices/${id}/stop`, {method: 'POST'});
            await updateDeviceFromServer(id);
        }
        async function runScenario(id, scenario) {
            await fetch(`/api/devices/${id}/scenarios/${scenario}`, {method: 'POST'});
            await updateDeviceFromServer(id);
        }
        async function updateDeviceFromServer(id) {
            const resp = await fetch(`/api/devices/${id}`);
            if (resp.ok) {
                const dev = await resp.json();
                updateDevice(dev);
                deviceMap.set(dev.id, dev);
            }
        }
        async function showHistory(id) {
            const resp = await fetch(`/api/devices/${id}/history`);
            const history = await resp.json();
            const cont = document.getElementById(`history-${id}`);
            if (!Array.isArray(history) || history.length === 0) {
                cont.innerHTML = '<div class="history-title">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
                return;
            }
            let html = `<div class='history-title'>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ—Ä–µ–Ω–∏–π <button class='close-btn' onclick=\"closeHistory('${id}')\">√ó</button></div>`;
            html += `<table class='history-table'><tr><th>–í—Ä–µ–º—è</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>`;
            for (const rec of history) {
                html += `<tr><td>${rec.timestamp.replace('T',' ')}</td><td>${rec.value}</td></tr>`;
            }
            html += '</table>';
            cont.innerHTML = html;
        }
        function closeHistory(id) {
            document.getElementById(`history-${id}`).innerHTML = '';
        }
        fetchDevices();
        setInterval(fetchDevices, 5000);
    </script>
</body>
</html>
